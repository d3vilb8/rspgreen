import{r as n,b as v,j as e}from"./app-DecQ0f_S.js";import{h as m,C as We}from"./index-BUFfQDDt.js";import{u as Ce}from"./index-DAUA1xsM.js";import{H as Oe,N as Ae,B as $e}from"./Nav-BWBa_EZw.js";import{F as He}from"./index-c1-G4gL8.js";import"./iconBase-DWhxbjqT.js";import"./index-gHrjMQXW.js";import"./index-BPKSu1J7.js";const at=({leave:j,user:I,user_type:J,permissions:Fe,notif:K,userid:Q,employee:u})=>{const[Z,ee]=n.useState(!1),[b,Pe]=n.useState({index:null,date:null}),[te,se]=n.useState(!0),E={id:Q};n.useEffect(()=>{setTimeout(()=>{se(!1)},10)},[]);const ae=(s,t,a)=>{const r=[...h];r[s][`description_${t}`]=a,w(r)};n.useState(new Date);const[re,W]=n.useState(!1),[h,w]=n.useState([]),[Re,oe]=n.useState([]),[D,ne]=n.useState({total:{},overtime:{}}),[Ue,ce]=n.useState({}),{data:Be,setData:T,post:_,errors:Le}=Ce({timesheets:[]}),[x,C]=n.useState(m().startOf("isoWeek").format("YYYY-MM-DD")),[O,de]=n.useState([]);n.useEffect(()=>{v.get(`/getProjectTasksEmployess/${u.id}`).then(s=>{const t=s.data||{};console.log("Fetched Project Tasks Data:",t),ce(t),oe(Object.keys(t).map(a=>({id:a,project_name:t[a].project_name,tasks:t[a].tasks})))}).catch(s=>console.error("Error fetching project tasks:",s)),v.get("/holidays-fetch").then(s=>{console.log("Fetched Holidays Data:",s.data),de(s.data)}).catch(s=>console.error("Error fetching holidays:",s))},[u.id]);const[Y,ie]=n.useState(null),[A,le]=n.useState(null);n.useEffect(()=>{me(x)},[x]),n.useEffect(()=>{console.log("Updated Week Data:",h)},[h]);const me=s=>{v.get(`/timesheets/${s}/${u.id}`).then(t=>{const a=t.data.map(r=>{const o=r.entries||{};return{project_id:r.project_id,project_name:r.project_name,task_id:r.task_id,task_name:r.task_name,status:r.status,is_approved:r.is_approved,...o}});a.length===0?W(!0):(W(!1),w(a),T("timesheets",a),a[0]&&a[0].status!==void 0&&ie(a[0].status),a[0]&&a[0].is_approved!==void 0&&le(a[0].is_approved)),B(a)}).catch(t=>console.error("Error fetching the timesheet data!",t))},i=s=>m(x).startOf("isoWeek").add(s,"days").format("YYYY-MM-DD"),ue=s=>{const t=m(x).startOf("isoWeek").add(s,"days"),a=t.format("ddd"),r=t.format("MMM D");return{dayName:a,dayDate:r}},he=()=>{C(m(x).subtract(1,"weeks").format("YYYY-MM-DD"))},pe=()=>{C(m(x).add(1,"weeks").format("YYYY-MM-DD"))},xe=new Date(j==null?void 0:j.sdate),fe=new Date(j==null?void 0:j.edate),$=s=>{const t=new Date(s);return t>=xe&&t<=fe},H=s=>O.some(t=>{const a=m(t.start_date,"YYYY-MM-DD"),r=m(t.end_date,"YYYY-MM-DD");return m(s,"YYYY-MM-DD").isBetween(a,r,"day","[]")}),F=(s,t)=>O.some(a=>{const r=m(a.start_date,"YYYY-MM-DD"),o=m(a.end_date,"YYYY-MM-DD");return m(s,"YYYY-MM-DD").isBetween(r,o,"day","[]")&&a.assigned_employees.some(N=>N.id===t)}),[g,S]=n.useState(""),[Ve,je]=n.useState(!1),[y,P]=n.useState([]),[ze,R]=n.useState(""),be=async(s,t,a)=>{const r=Number(a)||0,o=[...h];o[s]={...o[s],[t]:r};const c=Object.values(o[s]).filter(d=>!isNaN(d)&&d!=="").reduce((d,f)=>d+Number(f),0),l=o[s].estimateHours||5,N=c>=l;o[s].disabled=N||Y===1||$(t)||H(t)&&!F(t,E.id)||V(t),w(o);const z=o.map((d,f)=>({...d,date:i(f%7)})),X=y.map(d=>{const k=z.filter(p=>p.task_id===d.task_id).reduce((p,M)=>p+(Number(M.time_number)||0),0);return{...d,total_time_worked:k}});P(X);let q=!1;const G=[],Ee=z.map((d,f)=>{const k=X.find(p=>p.task_id===d.task_id);if(k){const p=Number(k.estimate_hours),M=Number(d.time_number||0);if(Number(k.total_time_worked||0)+M>p)return G.push(`Task ${k.task_name} has exceeded its estimated hours of ${p}. Please submit your extra task hour in NON-Billable.`),q=!0,{...d,date:i(f%7),time_number:p.toString()}}return{...d,date:i(f%7)}});S(G.join(`
`)),je(q);try{await v.post("/timesheets-store",{timesheets:Ee}),R("Timesheets updated successfully."),S("")}catch(d){console.error("Error submitting timesheets:",d),S("There was an error saving the timesheets. Please try again."),R("")}B(o)};n.useEffect(()=>{g&&console.log("Error:",g)},[g]),n.useEffect(()=>{(async()=>{try{const t=await v.get(`/timesheets-time/${u.id}`);P(t.data)}catch(t){console.error("Error fetching data:",t)}})()},[h,y]);const[U,ke]=n.useState([]);n.useEffect(()=>{const s=y.filter(t=>{const a=Number(t.total_time_worked),r=Number(t.estimate_hours);return a>r});ke(s)},[y]);const ge=s=>{s.preventDefault();const t=h.map((a,r)=>({...a,date:i(r%7)}));T("timesheets",t),console.log(u.user_id),_(`/timesheetemp-employee-status/${u.id}`,{preserveScroll:!0,onSuccess:()=>console.log("Timesheets status updated successfully"),onError:()=>console.error("Error updating the timesheets status")})},Ne=s=>{s.preventDefault();const t=h.map((a,r)=>({...a,date:i(r%7)}));T("timesheets",t),console.log(u.user_id),_(`/approvetime/${u.id}`,{preserveScroll:!0,onSuccess:()=>console.log("Timesheets status Approved successfully"),onError:()=>console.error("Error updating the timesheets status")})},ve=s=>{s.preventDefault();const t=h.map((a,r)=>({...a,date:i(r%7)}));T("timesheets",t),console.log(u.user_id),_(`/rejectapprovetime/${u.id}`,{preserveScroll:!0,onSuccess:()=>console.log("Timesheets status Approved successfully"),onError:()=>console.error("Error updating the timesheets status")})},B=s=>{const t={total:{},overtime:{}};for(let a=0;a<7;a++){const r=i(a);let o=0;s.forEach(c=>{const l=c[r]?parseFloat(c[r]):0;o+=l}),t.total[r]=o,o===0?t.overtime[r]=0:(o>8,t.overtime[r]=o-8)}ne(t)},De=s=>{const t=m(s).startOf("isoWeek"),a=m(s).endOf("isoWeek");return{start:t,end:a}},Te=(s,t)=>{const a=s.format("dddd, MMMM DD, YYYY"),r=t.format("dddd, MMMM DD, YYYY");return`${a} - ${r}`},L=De(x),ye=Te(L.start,L.end),V=s=>{const t=m(x).startOf("isoWeek").add(s,"days").day();return t===6||t===0},we=()=>{let s=0,t=0;return h.forEach(a=>{Array.from({length:7}).forEach((r,o)=>{const c=i(o),l=parseFloat(a[c]||0);s+=l,l>8?t+=1:l<8&&(t+=8-l)})}),{weeklyTotala:s,weeklyOverUnderTimeCount:t}},{weeklyTotala:_e,weeklyOverUnderTimeCount:Xe}=we(),Ye=Array.from({length:7}).reduce((s,t,a)=>{const r=i(a),o=D.overtime[r]||0;return o<0&&(s+=Math.abs(o)),s},0),Se=Array.from({length:7}).reduce((s,t,a)=>{const r=i(a),o=D.overtime[r]||0;return o>0&&(s+=o),s},0);n.useState();const Me=Se+Ye;return e.jsxs("div",{className:"w-[83%]  absolute right-0 overflow-hidden",children:[e.jsx(Oe,{user:I,notif:K}),e.jsx(Ae,{user_type:J}),e.jsxs("div",{children:[" ",te?e.jsx("span",{className:"grid place-items-center h-[20rem]",children:e.jsx("l-waveform",{size:"35",stroke:"3.5",speed:"1",color:"black"})}):e.jsxs(e.Fragment,{children:[" ",e.jsx("div",{className:`modal absolute top-0 left-0 w-full h-full transition-all duration-500 bg-black/50 flex justify-center items-center ${Z?"opacity-100 visible pointer-events-auto":"opacity-0 invisible pointer-events-none"}`,children:e.jsxs("div",{className:"w-2/5 p-4 px-6 bg-white rounded-md",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Add Description"}),e.jsx("button",{onClick:()=>ee(!1),children:e.jsx(He,{})})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("form",{className:"py-3 space-y-5",children:[e.jsx("textarea",{type:"text",className:"w-full p-2 border rounded-md",placeholder:"Description",value:b.index!==null&&b.date!==null&&h[b.index][`description_${b.date}`]||"",onChange:s=>ae(b.index,b.date,s.target.value)}),e.jsx("div",{})]})]})}),e.jsxs("p",{className:"ml-5",children:["UnLock Timesheet for the Employee"," ",e.jsx("span",{class:"font-bold",children:u.name})]}),e.jsxs("div",{className:"space-x-2",style:{display:"flex",justifyContent:"space-between",margin:"1rem"},children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-bold ",children:"Week"}),":"," ",e.jsxs("span",{className:"text-red-500 underline",children:[" ",ye]})]}),e.jsxs("div",{children:[e.jsx("button",{onClick:he,className:"underline",children:e.jsx($e,{className:"text-[2rem] text-blue-500"})}),e.jsx("button",{onClick:pe,className:"underline",children:e.jsx(We,{className:"text-[2rem] text-blue-500"})})]})]}),e.jsxs("div",{className:"px-4",children:[g&&e.jsx("div",{className:"error-message",children:g}),U.length>0&&e.jsx("div",{className:"text-red-500",children:U.map((s,t)=>e.jsxs("p",{children:["Task ",s.task_name," has exceeded its estimated hours of"," ",s.estimate_hours,".please Submit your extra task hour in NON-Billable"]},t))}),e.jsxs("form",{onSubmit:s=>s.preventDefault(),children:[e.jsxs("table",{className:"w-full  border-[3px]",children:[e.jsx("thead",{className:"bg-[#465584] text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-1 border",children:"Task"}),Array.from({length:7}).map((s,t)=>{const{dayName:a,dayDate:r}=ue(t);return e.jsxs("th",{className:"p-1 text-center border",children:[e.jsx("div",{children:r}),e.jsx("div",{children:a})]},t)}),e.jsx("td",{className:"w-[88px]",children:"Total Time"})]})}),e.jsx("tbody",{children:re?e.jsx("tr",{children:e.jsxs("td",{colSpan:"8",children:[" ",e.jsxs("p",{className:"grid place-items-center",children:[" ",e.jsx("h1",{className:"font-bold text-[1.5rem]",children:"We couldn't find any data"}),"Sorry we can't find any timesheet records on this week. Please add timesheet record ."]})]})}):e.jsxs(e.Fragment,{children:[h.map((s,t)=>{console.log(s);const a=Array.from({length:7}).reduce((r,o,c)=>{const l=i(c);return r+parseFloat(s[l]||0)},0);return e.jsxs("tr",{children:[e.jsx("td",{className:"bg-[#6699CC] text-white w-[97px] border text-[0.9rem]",children:e.jsx("div",{children:s.project_name})}),e.jsx("td",{className:"bg-[#6699CC] text-white w-[97px] border",children:s.task_name}),Array.from({length:7}).map((r,o)=>{const c=i(o),l=Y===1||$(c)||H(c)&&!F(c,E.id)||V(c);return e.jsx("td",{className:"w-[97px] bg-white border-2 ",children:e.jsx("div",{className:"flex",children:e.jsx("input",{className:`form-control ${l?"bg-[#f7e0e0] text-white w-[97px] border-[#594684]":"w-[60px] border-[#465584]"}`,type:"number",name:`timesheets[${t}][${c}]`,value:s[c]||"",onChange:N=>be(t,c,N.target.value),disabled:l})})},o)}),e.jsx("td",{className:"bg-white",children:e.jsx("input",{className:" text-center form-control w-[88px] bg-[#d3e0ea] text-black",type:"number",value:a,disabled:!0})})]},t)}),e.jsxs("tr",{className:"bg-[#e0f7e0] ",children:[e.jsx("td",{className:"border "}),e.jsx("td",{className:"border ",children:"Total"}),Array.from({length:7}).map((s,t)=>{const a=i(t);return e.jsx("td",{className:"p-2 border",children:D.total[a]||0},t)}),e.jsx("td",{className:"text-center",children:_e})]}),e.jsxs("tr",{className:"bg-[#fff] ",children:[e.jsx("td",{className:"border "}),e.jsxs("td",{className:"border ",children:[" ","Extra Work hours"," "]}),Array.from({length:7}).map((s,t)=>{const a=i(t),r=D.overtime[a]||0,o=r>0?`+${r}`:r;return e.jsx("td",{style:{color:o>0?"green":"red"},className:"p-2 text-center border",children:r===0?0:o},t)}),e.jsxs("td",{className:"text-center",children:["-",Me]})]})]})})]}),e.jsxs("div",{className:"flex justify-end   bg-[#356A6A]",children:[e.jsx("div",{className:"w-[50%] grid place-items-center border-2 p-3",children:A===3?e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("button",{onClick:Ne,className:"p-2 text-white bg-green-800 border-2 rounded-md",children:"Approve timesheet"}),e.jsx("button",{onClick:ve,className:"p-2 text-white bg-red-500 border-2 rounded-md",children:"Reject timesheet"})]}):e.jsx("div",{className:"mt-3",children:A===1?e.jsx("span",{className:"font-bold text-green-600",children:"Timesheet Approved"}):e.jsx("span",{className:"font-bold text-red-600",children:"Timesheet Rejected"})})}),e.jsx("div",{className:"w-[50%] grid place-items-center border-2 p-3",children:Y===1?e.jsxs(e.Fragment,{children:[" ",e.jsx("button",{onClick:ge,className:"border-2 p-2 bg-[#F06495] text-white rounded-md",children:"Unlock timesheet"})," ",e.jsx("br",{})]}):e.jsx("p",{className:"mt-3 text-white",children:"Unlocking of the timesheet has been done."})})]})]})]})]})]})]})};export{at as default};
