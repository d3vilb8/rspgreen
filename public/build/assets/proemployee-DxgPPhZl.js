import{r as o,j as e,b as z}from"./app-DecQ0f_S.js";import{u as U,L as G}from"./index-DAUA1xsM.js";import{H as J,N as K}from"./Nav-BWBa_EZw.js";import{N as W}from"./notyf.min-DLu_xjpT.js";import{M as X}from"./index-Cx50FlE7.js";import"./index-gHrjMQXW.js";import"./iconBase-DWhxbjqT.js";import"./index-BPKSu1J7.js";import"./index-c1-G4gL8.js";const d=new W,me=({user:C,tasks:i,user_type:E,notif:F,taskcategory:P,employee:b,projects:c})=>{const[m,Y]=o.useState(""),[y,T]=o.useState([]),[N,L]=o.useState(1),[j]=o.useState(10),[A,M]=o.useState(!1),[H,Z]=o.useState(""),[u,O]=o.useState(""),{data:l,setData:w,post:I,errors:ee}=U({task_name:"",estimate_hours:"",sdate:"",edate:"",employee_id:[],status:"",project_id:c.length>0?c[0].id:""});o.useEffect(()=>{const a=i.flatMap(s=>s.tasks).filter(s=>(m===""||s.task_name.toLowerCase().includes(m.toLowerCase())||s.users.some(r=>r.name.toLowerCase().includes(m.toLowerCase())))&&(u===""||i.some(r=>r.title.toLowerCase().includes(u.toLowerCase())&&r.tasks.includes(s))));T(a)},[m,u,i]);const h=t=>{const{name:a,value:s}=t.target;console.log(`Selected ${a}: ${s}`),w(r=>({...r,[a]:s}))},D=()=>{M(!1)},v=N*j,$=v-j,_=y.slice($,v),q=Math.ceil(y.length/j),B=Array.from({length:q},(t,a)=>a+1),k=(t,a)=>{w("employee_id",t.map(s=>s.id))},Q=async t=>{t.preventDefault(),console.log("Project ID:",l.project_id),console.log("Projects Array:",c);const a=parseInt(l.project_id),s=c.find(n=>n.id===a);if(!s){d.error("Selected project not found."),console.error("Selected project not found.");return}const r=parseFloat(l.estimate_hours);try{const n=await z.get(`/project-tasks/${a}/total-hours`),p=parseFloat(n.data.total_hours)+r,S=parseFloat(s.estimate_time);if(p>S){d.error(`Total hours exceed the allowed limit for the project. Maximum allowed: ${S} hours.`);return}I("/task-store",{data:l,onSuccess:()=>{d.success("Task created successfully with notification sent.")},onError:x=>{typeof x=="object"&&x!==null?Object.entries(x).forEach(([te,g])=>{Array.isArray(g)?g.forEach(V=>d.error(V)):d.error(g)}):d.error("An unexpected error occurred."),console.error("Server-side validation errors:",x)}})}catch(n){console.error("Error fetching total task hours:",n),d.error("Failed to validate project hours. Please try again later.")}},R=l.task_name.replace(/\u00A0/g," ").trim();return e.jsxs("div",{className:"w-[85.2%] absolute right-0 overflow-hidden",children:[e.jsx(J,{user:C,notif:F}),e.jsx(K,{user_type:E}),e.jsxs("div",{className:"px-8 table-section",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{className:"w-[40%] flex space-x-2",children:e.jsx("input",{type:"text",value:u,onChange:t=>O(t.target.value),placeholder:"Search projects...",className:"w-full p-2 border rounded-md"})}),e.jsx("div",{className:"flex",children:e.jsx("div",{className:"grid p-2 mt-2 text-black underline rounded-lg place-items-center",children:e.jsx(G,{href:"projects-create",children:"Add New"})})})]}),e.jsx("br",{}),e.jsxs("table",{className:"w-full border border-collapse border-gray-200 table-auto",children:[e.jsx("thead",{className:"bg-[#0A1B3F] text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"Project Name"}),e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"Estimate Hours"}),e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"Assigned Users"})]})}),e.jsx("tbody",{children:_.length>0?i.map((t,a)=>{const s=_.filter(r=>r.project_id===t.id);return s.length===0?null:s.map((r,n)=>e.jsxs("tr",{children:[n===0&&e.jsxs(e.Fragment,{children:[e.jsx("td",{rowSpan:s.length,className:"px-4 py-2 border border-gray-300 text-[0.9rem] font-bold",children:t.title}),e.jsxs("td",{rowSpan:s.length,className:"px-4 py-2 border border-gray-300 text-[0.9rem] font-bold",children:[t.estimate_time,"hrs"]})]}),e.jsx("td",{className:"px-4 py-2 border border-gray-300",children:r.users.map((f,p)=>e.jsxs("span",{className:"bg-blue-400 text-white text-xs font-medium me-2 px-2.5 py-0.5 rounded-full",children:[f.name," - ",f.pivot.employee_hours," hours",p<r.users.length-1&&", "]},p))})]},r.id))}):e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"p-3 text-center",children:"No tasks found"})})})]}),e.jsx("div",{className:"flex justify-center mt-4",children:B.map(t=>e.jsx("button",{onClick:()=>L(t),className:`px-4 py-2 mx-1 rounded ${N===t?"bg-blue-500 text-white":"bg-gray-200"}`,children:t},t))})]}),A&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50",children:e.jsx("form",{onSubmit:Q,className:"px-[8rem] items-center justify-center ",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Copied Project Name"}),e.jsx("input",{type:"text",value:H,readOnly:!0,className:"w-full p-2 border rounded-md mb-4"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"task_name",children:"Task Name"}),e.jsxs("select",{className:"w-full rounded-lg",name:"task_name",value:l.task_name,onChange:h,children:[e.jsx("option",{value:"",children:"Select task"}),P.map(t=>e.jsx("option",{value:t.tname,children:t.tname},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sdate",children:"Start Date"}),e.jsx("input",{className:"w-full rounded-lg",id:"sdate",name:"sdate",type:"date",value:l.sdate,onChange:h,required:!0})]}),e.jsx("div",{children:R!=="NON-BILLABLE"&&e.jsxs(e.Fragment,{children:[e.jsx("label",{htmlFor:"estimate_hours",children:"Estimate Hours"}),e.jsx("input",{className:"w-full rounded-lg",id:"estimate_hours",name:"estimate_hours",type:"number",value:l.estimate_hours,onChange:h})]})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"edate",children:"End Date"}),e.jsx("input",{className:"w-full rounded-lg",id:"edate",name:"edate",type:"date",value:l.edate,onChange:h,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"employee_id",children:"Assign Employees"}),e.jsx(X,{options:b,selectedValues:l.employee_id.map(t=>b.find(a=>a.id===t)),onSelect:k,onRemove:k,displayValue:"name",placeholder:"Select Employees"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:D,className:"mt-4 px-4 py-2 bg-red-500 text-white rounded",children:"Close"}),e.jsx("button",{type:"submit",className:"mt-4 px-4 py-2 bg-green-500 text-white rounded",children:"Create"})]})]})})})]})};export{me as default};
