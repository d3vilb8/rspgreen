import{r as n,W as Y,q as Z,j as e,a as P,b as F}from"./app-OWEBvdtC.js";import{H as ee,N as se}from"./Nav-CmIRCLvo.js";import{f as te}from"./index-CGRCqaVb.js";import{R as re}from"./index-R_jZdsaO.js";import{N as ae}from"./notyf.min-DLu_xjpT.js";import{M as le}from"./index-Dd66xK6T.js";import"./iconBase-hI8KM4xB.js";import"./index-BSTxKt_a.js";const d=new ae,ye=({user:T,tasks:m,user_type:A,notif:L,taskcategory:D,employee:b,projects:u})=>{var C;const[i,M]=n.useState(""),[g,H]=n.useState([]),[N,v]=n.useState(1),[j]=n.useState(10),[$,O]=n.useState(!1),[I,oe]=n.useState(""),[h,q]=n.useState(""),{data:o,setData:w,post:B,errors:ne}=Y({task_name:"",estimate_hours:"",sdate:"",edate:"",employee_id:[],status:"",project_id:u.length>0?u[0].id:""}),{props:c}=Z();n.useEffect(()=>{const r=m.flatMap(t=>t.tasks).filter(t=>(i===""||t.task_name.toLowerCase().includes(i.toLowerCase())||t.users.some(l=>l.name.toLowerCase().includes(i.toLowerCase())))&&(h===""||m.some(l=>l.title.toLowerCase().includes(h.toLowerCase())&&l.tasks.includes(t))));H(r)},[i,h,m]);const x=s=>{const{name:r,value:t}=s.target;console.log(`Selected ${r}: ${t}`),w(l=>({...l,[r]:t}))},R=(s,r)=>{s.preventDefault(),confirm("Are you sure you want to delete this task?")&&F.get(`/task-delete/${r}`).then(t=>{d.success("Task and related task assign deleted successfully."),window.location.reload()}).catch(t=>{console.log(t)})},Q=()=>{O(!1)},k=N*j,U=k-j,_=g.slice(U,k),V=Math.ceil(g.length/j),z=Array.from({length:V},(s,r)=>r+1),W=s=>{M(s.target.value),v(1)},S=(s,r)=>{w("employee_id",s.map(t=>t.id))},G=async s=>{s.preventDefault(),console.log("Project ID:",o.project_id),console.log("Projects Array:",u);const r=parseInt(o.project_id),t=u.find(a=>a.id===r);if(!t){d.error("Selected project not found."),console.error("Selected project not found.");return}const l=parseFloat(o.estimate_hours);try{const a=await F.get(`/project-tasks/${r}/total-hours`),K=parseFloat(a.data.total_hours)+l,E=parseFloat(t.estimate_time);if(K>E){d.error(`Total hours exceed the allowed limit for the project. Maximum allowed: ${E} hours.`);return}B("/task-store",{data:o,onSuccess:()=>{d.success("Task created successfully with notification sent.")},onError:p=>{typeof p=="object"&&p!==null?Object.entries(p).forEach(([de,f])=>{Array.isArray(f)?f.forEach(X=>d.error(X)):d.error(f)}):d.error("An unexpected error occurred."),console.error("Server-side validation errors:",p)}})}catch(a){console.error("Error fetching total task hours:",a),d.error("Failed to validate project hours. Please try again later.")}},J=o.task_name.replace(/\u00A0/g," ").trim();return e.jsxs("div",{className:"w-[85.2%] absolute right-0 overflow-hidden",children:[e.jsx(ee,{user:T,notif:L}),e.jsx(se,{user_type:A}),e.jsxs("div",{className:"px-8 table-section",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"w-[40%] flex space-x-2",children:[e.jsx("input",{type:"text",value:h,onChange:s=>q(s.target.value),placeholder:"Search projects...",className:"w-full p-2 border rounded-md"}),e.jsx("input",{type:"text",value:i,onChange:W,placeholder:"Search tasks...",className:"w-full p-2 border rounded-md"})]}),e.jsx("div",{className:"flex",children:c.permission.includes("create_task")&&e.jsx("div",{className:"grid p-2 mt-2 text-black underline rounded-lg place-items-center",children:e.jsx(P,{href:"task-create",children:"Add New"})})})]}),e.jsx("br",{}),e.jsxs("table",{className:"w-full border border-collapse border-gray-200 table-auto",children:[e.jsx("thead",{className:"bg-[#0A1B3F] text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"Project Name"}),e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"Start Date"}),e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"End Date"}),((C=c.auth.user.roles[0])==null?void 0:C.name)==="admin"&&e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"Assigned Users"}),e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"Priority"}),e.jsx("th",{className:"px-4 py-2 border border-gray-300",children:"Actions"})]})}),e.jsx("tbody",{children:_.length>0?_.map((s,r)=>{var t,l;return(t=m.find(a=>a.tasks.includes(s)))!=null&&t.title,e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 border border-gray-300 text-[0.9rem]",children:s.task_name}),e.jsx("td",{className:"px-4 py-2 border border-gray-300 text-[0.9rem]",children:s.sdate}),e.jsx("td",{className:"px-4 py-2 border border-gray-300 text-[0.9rem]",children:s.edate}),((l=c.auth.user.roles[0])==null?void 0:l.name)==="admin"&&e.jsx("td",{className:"px-4 py-2 border border-gray-300",children:s.users.map((a,y)=>e.jsxs("span",{className:"bg-blue-400 text-white text-xs font-medium me-2 px-2.5 py-0.5 rounded-full",children:[a.name," -"," ",a.pivot.employee_hours," ","hours",y<s.users.length-1&&", "]},y))}),e.jsx("td",{className:`px-4 py-2 font-semibold border border-gray-300 text-[0.9rem] ${s.priority===0?"text-green-600":s.priority===1?"text-amber-600":"text-red-500"}`,children:s.priority===0?"Low":s.priority==1?"Medium":"High"}),e.jsx("td",{className:"border border-gray-300",children:e.jsxs("div",{className:"flex px-4 py-2 space-x-2 ",children:[c.permission.includes("edit_task")&&e.jsx(P,{href:`/task-edit/${s.id}`,children:e.jsx(te,{className:"text-blue-500 cursor-pointer hover:text-blue-700"})}),c.permission.includes("delete_task")&&e.jsx(re,{className:"text-red-500 cursor-pointer hover:text-red-700",onClick:a=>R(a,s.id)})]})})]},r)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"p-3 text-center",children:"No tasks found"})})})]}),e.jsx("div",{className:"flex justify-center mt-4",children:z.map(s=>e.jsx("button",{onClick:()=>v(s),className:`px-4 py-2 mx-1 rounded ${N===s?"bg-blue-500 text-white":"bg-gray-200"}`,children:s},s))})]}),$&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50",children:e.jsx("form",{onSubmit:G,className:"px-[8rem] items-center justify-center ",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Copied Project Name"}),e.jsx("input",{type:"text",value:I,readOnly:!0,className:"w-full p-2 border rounded-md mb-4"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"task_name",children:"Task Name"}),e.jsxs("select",{className:"w-full rounded-lg",name:"task_name",value:o.task_name,onChange:x,children:[e.jsx("option",{value:"",children:"Select task"}),D.map(s=>e.jsx("option",{value:s.tname,children:s.tname},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sdate",children:"Start Date"}),e.jsx("input",{className:"w-full rounded-lg",id:"sdate",name:"sdate",type:"date",value:o.sdate,onChange:x,required:!0})]}),e.jsx("div",{children:J!=="NON-BILLABLE"&&e.jsxs(e.Fragment,{children:[e.jsx("label",{htmlFor:"estimate_hours",children:"Estimate Hours"}),e.jsx("input",{className:"w-full rounded-lg",id:"estimate_hours",name:"estimate_hours",type:"number",value:o.estimate_hours,onChange:x})]})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"edate",children:"End Date"}),e.jsx("input",{className:"w-full rounded-lg",id:"edate",name:"edate",type:"date",value:o.edate,onChange:x,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"employee_id",children:"Assign Employees"}),e.jsx(le,{options:b,selectedValues:o.employee_id.map(s=>b.find(r=>r.id===s)),onSelect:S,onRemove:S,displayValue:"name",placeholder:"Select Employees"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:Q,className:"mt-4 px-4 py-2 bg-red-500 text-white rounded",children:"Close"}),e.jsx("button",{type:"submit",className:"mt-4 px-4 py-2 bg-green-500 text-white rounded",children:"Create"})]})]})})})]})};export{ye as default};
